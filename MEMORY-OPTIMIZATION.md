# 内存优化说明

## 🎯 优化目标

减少服务器内存使用，提高应用性能和稳定性。

## 📊 优化内容

### ⏰ **过期时间缩短**
| 项目 | 之前 | 现在 | 节省 |
|------|------|------|------|
| 文本内容 | 24小时 | 10分钟 | 99.3% |
| 文件内容 | 24小时 | 10分钟 | 99.3% |
| 内存占用时间 | 长期积累 | 快速释放 | 显著减少 |

### 💾 **存储方式优化**

#### 📝 **文本存储**
- **位置**: 内存中 (ConcurrentDictionary)
- **原因**: 文本通常较小，内存访问速度快
- **过期**: 10分钟后自动清理

#### 📁 **文件存储** 
- **之前**: 完整文件内容存储在内存 `byte[]`
- **现在**: 文件保存到临时目录，内存只存储路径
- **位置**: `%TEMP%/web-clipboard/` 目录
- **优势**: 
  - 大文件不占用服务器内存
  - 支持任意大小的文件上传
  - 服务器内存使用稳定

## 🔧 **技术实现**

### 📂 **临时文件管理**
```csharp
// 临时目录创建
var tempDir = Path.Combine(Path.GetTempPath(), "web-clipboard");
Directory.CreateDirectory(tempDir);

// 文件保存格式: {ID}_{原文件名}
var filePath = Path.Combine(tempDir, $"{id}_{file.FileName}");

// ClipboardItem只存储文件路径
public string? FilePath { get; set; }
```

### ⚡ **自动清理机制**
```csharp
// 1. 启动时清理旧文件
foreach (var oldFile in Directory.GetFiles(tempDir))
{
    try { File.Delete(oldFile); } catch { }
}

// 2. 后台定时清理 (每分钟)
var cleanupTimer = new Timer(_ => {
    // 删除过期的内存记录和磁盘文件
}, null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(1));

// 3. API手动清理
GET /api/cleanup
```

## 📈 **性能改进**

### 🚀 **内存使用**
```
场景: 用户上传100MB视频文件

之前:
- 100MB文件 → 100MB内存占用
- 保留24小时 → 长期内存压力

现在: 
- 100MB文件 → ~1KB内存占用 (只存路径)
- 保留10分钟 → 快速释放资源
```

### ⏱️ **响应时间**
- **文本操作**: 无变化 (仍然很快)
- **文件上传**: 略有提升 (减少内存分配)
- **文件下载**: 无变化 (直接从磁盘流式传输)

### 🔄 **并发处理**
- **内存稳定**: 不再因大文件导致内存溢出
- **服务稳定**: 支持更多并发用户
- **资源可控**: 内存使用量可预测

## 🛡️ **安全性**

### 📁 **临时文件安全**
- **位置**: 系统临时目录，用户权限保护
- **命名**: 随机ID前缀，难以猜测
- **清理**: 多重清理机制，防止文件泄露

### ⏰ **快速过期**
- **10分钟**: 减少敏感数据暴露时间
- **自动清理**: 无需手动管理
- **即时生效**: 过期后立即无法访问

## 🧪 **测试验证**

### 📊 **内存测试**
```bash
# 运行内存优化测试
./test-memory-optimization.bat

# 检查临时文件目录
dir %TEMP%\web-clipboard

# 监控内存使用
任务管理器 → 性能 → 内存
```

### 📁 **文件存储测试**
```bash
# 1. 上传大文件
curl -X POST http://localhost:5000/api/file -F "file=@largefile.zip"

# 2. 检查内存使用 (应该很少)
# 3. 检查临时目录 (应该有文件)
# 4. 等待10分钟后检查清理效果
```

## 🌟 **优势总结**

### ✅ **内存效率**
- 大幅减少内存占用
- 支持任意大小文件
- 内存使用稳定可控

### ✅ **性能提升** 
- 服务器响应更稳定
- 支持更多并发用户
- 减少GC压力

### ✅ **用户体验**
- 上传大文件不受限制
- 服务不会因内存不足崩溃
- 响应时间保持稳定

### ✅ **运维友好**
- 内存使用可预测
- 自动清理机制
- 减少服务器资源需求

这些优化让Web剪贴板更适合生产环境部署！